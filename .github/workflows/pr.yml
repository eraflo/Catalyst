name: PR Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  # Check that version wasn't manually changed
  check-version:
    name: Check Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if version was changed
        run: |
          if git diff origin/${{ github.base_ref }}...HEAD --name-only | grep -q "package.json"; then
            OLD_VERSION=$(git show origin/${{ github.base_ref }}:package.json | jq -r '.version')
            NEW_VERSION=$(jq -r '.version' package.json)
            
            if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
              echo "::warning::Version was manually changed from $OLD_VERSION to $NEW_VERSION"
              echo "Note: Version will be automatically bumped on merge to main"
            fi
          fi

  # Lint commit messages
  lint-commits:
    name: Lint Commit Messages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check commit message format
        run: |
          echo "Checking commit messages for conventional format..."
          echo "Commits should follow: type(scope): message"
          echo "Types: feat, fix, docs, style, refactor, test, chore"
          echo ""
          
          git log --oneline origin/${{ github.base_ref }}...HEAD

  # Check for breaking changes
  breaking-changes:
    name: Check Breaking Changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Detect breaking changes
        run: |
          COMMITS=$(git log --oneline origin/${{ github.base_ref }}...HEAD)
          
          if echo "$COMMITS" | grep -qi "BREAKING CHANGE\|!:"; then
            echo "::warning::This PR contains breaking changes!"
            echo "A major version bump will occur on merge."
          elif echo "$COMMITS" | grep -qi "^feat"; then
            echo "This PR contains new features."
            echo "A minor version bump will occur on merge."
          else
            echo "This PR contains fixes/chores."
            echo "A patch version bump will occur on merge."
          fi
